<!--
SPDX-License-Identifier: MIT AND CC-BY-4.0
Copyright (c) 2025 John William Creighton (s243a)

This documentation is dual-licensed under MIT and CC-BY-4.0.
-->

# Chapter 19: WASM Visualization Examples

Browser-based visualization using Prolog compiled to WebAssembly via LLVM.

## Overview

UnifyWeaver can compile Prolog predicates to WebAssembly for browser execution:

```
Prolog â†’ LLVM IR â†’ WebAssembly â†’ TypeScript â†’ Browser
```

This enables:
- Interactive data visualization
- Client-side computation
- Portable, dependency-free web apps

## Two Visualization Patterns

| Pattern | Example | Library | Use Case |
|---------|---------|---------|----------|
| **Graph** | `wasm-graph` | Cytoscape.js | Network/tree structures |
| **Curve** | `curve-plot` | Chart.js | Mathematical functions |

Both follow the same pipeline architecture but target different visualization needs.

---

## Pattern 1: Graph Visualization (Cytoscape.js)

### Use Case

Visualize relationships from Prolog predicates like `parent/2` or `ancestor/2`.

### Example: Family Tree

```prolog
% family.pl - Define family relationships
parent(tom, bob).
parent(bob, alice).
parent(alice, eve).

% Transitive closure for ancestors
ancestor(X, Y) :- parent(X, Y).
ancestor(X, Y) :- parent(X, Z), ancestor(Z, Y).
```

### Compilation

```prolog
:- use_module('src/unifyweaver/targets/llvm_target').

% Compile to WASM with string support
generate_graph_wasm :-
    compile_wasm_string_module(
        [func(ancestor, 2, transitive_closure)],
        [module_name(family_graph)],
        LLVMCode),
    write_llvm_program(LLVMCode, 'family_graph.ll').
```

### Generated TypeScript API

```typescript
// Generated by UnifyWeaver
export class GraphWasm {
  static async load(wasmPath: string): Promise<GraphWasm>;

  addEdge(from: string, to: string): void;
  getEdges(): [string, string][];
  getEdgeCount(): number;

  ancestor(node: string): string[];
}
```

### Browser Integration

```typescript
import { GraphWasm } from './family_graph';
import cytoscape from 'cytoscape';

// Load WASM module
const graph = await GraphWasm.load('family_graph.wasm');

// Add edges from data
graph.addEdge('tom', 'bob');
graph.addEdge('bob', 'alice');

// Visualize with Cytoscape
const cy = cytoscape({
  container: document.getElementById('graph'),
  elements: graph.getEdges().map(([from, to]) => ({
    data: { source: from, target: to }
  }))
});
```

### Demo

See `examples/wasm-graph/index.html` for a complete interactive demo.

---

## Pattern 2: Curve Plotting (Chart.js)

### Use Case

Visualize mathematical functions defined in Prolog.

### Example: Mathematical Curves

```prolog
% curve_module.pl - Define curves
:- module(curve_module, [evaluate_curve/3, curve_points/4]).

% Evaluate curve at point X
evaluate_curve(sine(Amp, Freq, Phase), X, Y) :-
    Y is Amp * sin(Freq * X + Phase).

evaluate_curve(quadratic(A, B, C), X, Y) :-
    Y is A * X * X + B * X + C.

% Generate sample points
curve_points(CurveSpec, XMin, XMax, Points) :-
    NumPoints = 100,
    Step is (XMax - XMin) / NumPoints,
    findall([X, Y], (
        between(0, NumPoints, I),
        X is XMin + I * Step,
        evaluate_curve(CurveSpec, X, Y)
    ), Points).
```

### Compilation

```prolog
:- use_module(curve_module).

% Generate WASM-compatible LLVM IR
generate_curves :-
    generate_curve_wasm([
        curve_def(wave, sine),
        curve_def(parabola, quadratic),
        curve_def(growth, exponential)
    ], LLVMCode),
    write_llvm_program(LLVMCode, 'curve_plot.ll').
```

### Generated TypeScript API

```typescript
// Generated by UnifyWeaver
export class CurveWasm {
  static async load(wasmPath: string): Promise<CurveWasm>;

  // Parameter setters for each curve type
  set_wave_params(amp: number, freq: number, phase: number): void;
  set_parabola_params(a: number, b: number, c: number): void;

  // Curve evaluation
  eval_wave(x: number): number;
  eval_parabola(x: number): number;

  // Point generation
  generate_wave(xMin: number, xMax: number, numPoints: number): void;
  getPoints(): [number, number][];

  // Chart.js helper
  toChartData(label: string, color: string): ChartData;
}
```

### Browser Integration

```typescript
import { CurveWasm } from './curve_wasm';
import Chart from 'chart.js';

// Load WASM module
const curves = await CurveWasm.load('curve_plot.wasm');

// Configure sine wave
curves.set_wave_params(1.0, 2.0, 0.0);  // amp=1, freq=2, phase=0
curves.generate_wave(-10, 10, 200);

// Create Chart.js chart
new Chart(document.getElementById('chart'), {
  type: 'line',
  data: curves.toChartData('sin(2x)', '#00d4ff')
});
```

### Demo

See `examples/curve-plot/index.html` for a complete interactive demo with:
- Multiple curve types (linear, quadratic, sine, cosine, exponential)
- Adjustable parameters via UI controls
- Multiple curve overlays

---

## Building WASM Modules

### Prerequisites

```bash
# Ubuntu/Debian
sudo apt install llvm clang lld

# Verify installation
llc --version
wasm-ld --version
```

### Build Steps

```bash
# 1. Generate LLVM IR from Prolog
swipl -g "generate_all" -t halt curve_module.pl

# 2. Fix Prolog escaping (double %%)
sed -i 's/%%/%/g' curve_plot.ll

# 3. Compile to WASM object
llc -march=wasm32 -filetype=obj curve_plot.ll -o curve_plot.o

# 4. Link to WASM module
wasm-ld --no-entry --export-all curve_plot.o -o curve_plot.wasm

# 5. Serve and test
python3 -m http.server 8080
# Open http://localhost:8080
```

### Makefile Example

```makefile
.PHONY: all clean

LLVM_FILES = curve_plot.ll
WASM_FILES = curve_plot.wasm

all: $(WASM_FILES)

%.ll: %.pl
	swipl -g "generate_all" -t halt $<
	sed -i 's/%%/%/g' $@

%.o: %.ll
	llc -march=wasm32 -filetype=obj $< -o $@

%.wasm: %.o
	wasm-ld --no-entry --export-all $< -o $@

clean:
	rm -f $(LLVM_FILES) $(WASM_FILES) *.o
```

---

## Custom Chart Component

For declarative chart configuration without writing TypeScript:

```prolog
:- use_module('src/unifyweaver/targets/typescript_runtime/custom_chart').

% Declare a chart component
declare_component(source, math_chart, custom_chart, [
    chart_type(line),
    title("Mathematical Functions"),
    x_axis([label("X"), type(linear), min(-10), max(10)]),
    y_axis([label("Y")]),
    datasets([
        dataset([label("sin(x)"), color("#00d4ff")]),
        dataset([label("cos(x)"), color("#7c3aed")])
    ])
]).
```

This generates TypeScript code to create a pre-configured Chart.js chart.

---

## Architecture Comparison

### Graph Pattern
```
Prolog parent/2 facts
       â†“
LLVM (edge storage, BFS traversal)
       â†“
WASM (string handling, memory management)
       â†“
TypeScript (GraphWasm class)
       â†“
Cytoscape.js (network layout)
```

### Curve Pattern
```
Prolog curve definitions
       â†“
LLVM (float math, intrinsics)
       â†“
WASM (point storage, evaluation)
       â†“
TypeScript (CurveWasm class)
       â†“
Chart.js (line plotting)
```

---

## Exercises

1. **Add a new curve type**: Implement `cubic(A, B, C, D)` for y = axÂ³ + bxÂ² + cx + d

2. **Graph extensions**: Add a `shortest_path/3` predicate and compile it to WASM

3. **Hybrid visualization**: Create a demo that shows both a graph and curves side-by-side

4. **Performance comparison**: Benchmark WASM evaluation vs. pure JavaScript for 10,000 curve points

---

## Troubleshooting

### "import not found" in browser
Ensure you're serving files with a web server, not opening directly:
```bash
python3 -m http.server 8080
```

### LLVM math intrinsics not available
Use the software implementations or ensure your LLVM version supports wasm32 intrinsics.

### Memory errors in WASM
Check that you're not exceeding the allocated memory (default 64KB = 1 page). Increase with:
```llvm
@memory = global [131072 x i8] zeroinitializer  ; 128KB
```

---

**â†** [Previous: LLVM Examples](18_llvm_examples.md) | [ðŸ“– Book: Cross-Target Glue](./)
