<!--
SPDX-License-Identifier: MIT AND CC-BY-4.0
Copyright (c) 2025 John William Creighton (s243a)
-->

# Chapter 2: Architecture - Implementation Details

This document provides function-level documentation for the Prolog target transpilation pipeline.

**Source**: `src/unifyweaver/targets/prolog_target.pl`, `src/unifyweaver/targets/prolog_dialects.pl`

---

## Overview: Module Structure

```
src/unifyweaver/targets/
│
├── prolog_target.pl           # Main orchestrator
│   ├── generate_prolog_script/3
│   ├── analyze_dependencies/2
│   ├── write_prolog_script/3
│   └── compile_script_safe/3
│
├── prolog_dialects.pl         # Dialect abstraction
│   ├── supported_dialect/1
│   ├── dialect_*/* (code generation)
│   └── validate_for_dialect/3
│
└── prolog_service_target.pl   # Service integration
```

---

## generate_prolog_script/3

Main entry point for Prolog script generation.

### Signature

```prolog
generate_prolog_script(+UserPredicates, +Options, -ScriptCode)
```

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `UserPredicates` | `list` | List of `Pred/Arity` to include |
| `Options` | `list` | Generation options |
| `ScriptCode` | `atom` | Generated script content |

### Options

| Option | Default | Description |
|--------|---------|-------------|
| `dialect(D)` | `swi` | Target dialect (swi, gnu) |
| `compile(Bool)` | `false` | Compile to native binary |
| `entry_point(Goal)` | - | Main goal to execute |
| `output_file(Path)` | - | Output file path |

### Example

```prolog
generate_prolog_script(
    [factorial/2],
    [dialect(gnu), compile(true), entry_point(test_factorial)],
    ScriptCode
).
```

---

## Generation Pipeline Steps

### Step 0: Dialect Validation

```prolog
option(dialect(Dialect), Options, swi),
supported_dialect(Dialect),
validate_for_dialect(Dialect, UserPredicates, Issues)
```

### Step 1: Dependency Analysis

```prolog
analyze_dependencies(UserPredicates, Dependencies)
```

Output:
```prolog
Dependencies = [
    module(unifyweaver(core/partitioner)),
    ensure_loaded(unifyweaver(core/partitioners/fixed_size)),
    plugin_registration(partitioner, fixed_size, fixed_size_partitioner)
]
```

### Step 2: Shebang Generation

```prolog
dialect_shebang(Dialect, ShebangCode)
```

| Dialect | Shebang |
|---------|---------|
| `swi` | `#!/usr/bin/env swipl` |
| `gnu` | `#!/usr/bin/env gprolog --consult-file` |

### Step 3: Header Generation

```prolog
dialect_header(Dialect, Options, HeaderCode)
```

Output:
```prolog
% Generated by UnifyWeaver v0.1
% Target: Prolog (GNU Prolog)
% Compilation: interpreted
% Generated: 2025-11-17 22:13:14
```

### Step 4: Import Generation

```prolog
dialect_imports(Dialect, Dependencies, ImportsCode)
```

SWI output:
```prolog
:- use_module(unifyweaver(core/partitioner)).
:- ensure_loaded(unifyweaver(core/partitioners/fixed_size)).
```

### Step 5: User Code Extraction

```prolog
generate_user_code(UserPredicates, Options, UserCode)
```

### Step 6: Entry Point Generation

```prolog
generate_main_predicate(Options, MainCode)
```

Output:
```prolog
main :-
    test_factorial,
    halt(0).

main :-
    format(user_error, 'Error: Execution failed~n', []),
    halt(1).
```

### Step 7: Initialization Code

```prolog
dialect_initialization(Dialect, EntryGoal, Options, InitCode)
```

| Dialect | Compiled | Output |
|---------|----------|--------|
| `gnu` | Yes | `:- initialization(goal).` |
| `gnu` | No | `:- goal.` |
| `swi` | - | `:- initialization(goal, main).` |

### Step 8: Assembly

```prolog
atomic_list_concat([
    ShebangCode, HeaderCode, ImportsCode, UserCode,
    '\n% === Entry Point ===', MainCode, InitCode
], '\n\n', ScriptCode)
```

---

## analyze_dependencies/2

Scans predicates to find required modules.

### Signature

```prolog
analyze_dependencies(+Predicates, -Dependencies)
```

### Dependency Types

| Type | Example |
|------|---------|
| `module(M)` | `module(unifyweaver(core/partitioner))` |
| `ensure_loaded(F)` | `ensure_loaded(unifyweaver(core/partitioners/fixed_size))` |
| `plugin_registration(T,N,P)` | `plugin_registration(partitioner, fixed_size, ...)` |

---

## Dialect Predicates

### supported_dialect/1

```prolog
supported_dialect(swi).
supported_dialect(gnu).
```

### dialect_capabilities/2

```prolog
dialect_capabilities(Dialect, Capabilities)
```

Returns list of features supported by dialect.

### dialect_shebang/2

```prolog
dialect_shebang(swi, '#!/usr/bin/env swipl').
dialect_shebang(gnu, '#!/usr/bin/env gprolog --consult-file').
```

### dialect_compile_command/3

```prolog
dialect_compile_command(gnu, ScriptPath, Command) :-
    format(atom(Command), 'gplc -o ~w ~w', [Output, ScriptPath]).
```

### validate_for_dialect/3

```prolog
validate_for_dialect(+Dialect, +Predicates, -Issues)
```

Returns list of compatibility issues.

---

## write_prolog_script/3

Writes generated script to file.

### Signature

```prolog
write_prolog_script(+ScriptCode, +OutputPath, +Options)
```

### Actions

1. Write file with UTF-8 encoding
2. Set executable permission (`chmod +x`)
3. Compile if `compile(true)` in options

---

## compile_script_safe/3

Compiles with error handling.

### Signature

```prolog
compile_script_safe(+Dialect, +ScriptPath, +Options)
```

### Behavior

```prolog
compile_script_safe(Dialect, ScriptPath, Options) :-
    catch(
        compile_script(Dialect, ScriptPath),
        error(compilation_failed(FailedDialect, ExitCode), Context),
        handle_compilation_failure(...)
    ).
```

- Attempts compilation
- Catches failures (non-zero exit)
- Logs warnings
- Continues with interpreted script (unless `fail_on_compile_error(true)`)

---

## Data Flow

```
User Predicates ──┐
                  │
Options ──────────┼──► generate_prolog_script/3
                  │            │
                  │            ├─► analyze_dependencies/2
                  │            │        └─► Dependencies
                  │            │
                  │            ├─► dialect_shebang/2
                  │            ├─► dialect_header/3
                  │            ├─► dialect_imports/3
                  │            ├─► generate_user_code/3
                  │            ├─► generate_main_predicate/2
                  │            └─► dialect_initialization/4
                  │                     │
                  └─────────────────────┘
                                        ▼
                                  ScriptCode (atom)
                                        │
                                        ▼
                          write_prolog_script/3
                                        │
                                        ├─► Write file
                                        ├─► chmod +x
                                        └─► compile_script_safe/3
```

---

## Design Principles

| Principle | Implementation |
|-----------|----------------|
| Separation of Concerns | Dialect logic in `prolog_dialects.pl` |
| Extensibility | New dialects only modify dialect module |
| Robustness | Safe wrappers for failing operations |
| Testability | Each step is separate predicate |

---

## Related Documentation

- [Book 11 Chapter 1: Introduction](../01_introduction.md)
- [Book 11 Chapter 3: Dialects](../03_dialects.md)
- [Prolog Target Source](../../../../src/unifyweaver/targets/prolog_target.pl)
